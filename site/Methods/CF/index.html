


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="TSInterpret is a Python library for interpretable time series classification.">
      
      
      
        <meta name="author" content="Jacqueline HÃ¶llig">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-5.5.0">
    
    
      
        <title>CF - TSInterpret</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.b5d04df8.min.css">
      
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    
      
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#TSInterpret.InterpretabilityModels.counterfactual.CF" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="../.." title="TSInterpret" class="md-header-nav__button md-logo" aria-label="TSInterpret">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            TSInterpret
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              CF
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="TSInterpret" class="md-nav__button md-logo" aria-label="TSInterpret">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    TSInterpret
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../InterpretabilityMethods/" title="Interpretability" class="md-nav__link">
      Interpretability
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Usage
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Usage" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Usage
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-1" type="checkbox" id="nav-3-1">
    
    <label class="md-nav__link" for="nav-3-1">
      Counterfactuals
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Counterfactuals" data-md-level="2">
      <label class="md-nav__title" for="nav-3-1">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Counterfactuals
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../Notebooks/Ates_torch.ipynb" title="Ates" class="md-nav__link">
      Ates
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      API References
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="API References" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        API References
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../Model_Interface/" title="Models" class="md-nav__link">
      Models
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#TSInterpret.InterpretabilityModels.counterfactual.CF" class="md-nav__link">
    TSInterpret.InterpretabilityModels.counterfactual.CF
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#TSInterpret.InterpretabilityModels.counterfactual.CF.CF" class="md-nav__link">
    CF
  </a>
  
    <nav class="md-nav" aria-label="CF">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#TSInterpret.InterpretabilityModels.counterfactual.CF.CF.explain" class="md-nav__link">
    explain()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#TSInterpret.InterpretabilityModels.counterfactual.CF.CF.plot" class="md-nav__link">
    plot()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#TSInterpret.InterpretabilityModels.counterfactual.CF.CF.plot_in_one" class="md-nav__link">
    plot_in_one()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#TSInterpret.InterpretabilityModels.counterfactual.NativeGuideCF" class="md-nav__link">
    TSInterpret.InterpretabilityModels.counterfactual.NativeGuideCF
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#TSInterpret.InterpretabilityModels.counterfactual.NativeGuideCF.NativeGuideCF" class="md-nav__link">
    NativeGuideCF
  </a>
  
    <nav class="md-nav" aria-label="NativeGuideCF">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#TSInterpret.InterpretabilityModels.counterfactual.NativeGuideCF.NativeGuideCF.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#TSInterpret.InterpretabilityModels.counterfactual.NativeGuideCF.NativeGuideCF.explain" class="md-nav__link">
    explain()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#TSInterpret.InterpretabilityModels.counterfactual.NativeGuideCF.NativeGuideCF.native_guide_retrieval" class="md-nav__link">
    native_guide_retrieval()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#TSInterpret.InterpretabilityModels.counterfactual.Ates" class="md-nav__link">
    TSInterpret.InterpretabilityModels.counterfactual.Ates
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#TSInterpret.InterpretabilityModels.counterfactual.Ates.AtesCF" class="md-nav__link">
    AtesCF
  </a>
  
    <nav class="md-nav" aria-label="AtesCF">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#TSInterpret.InterpretabilityModels.counterfactual.Ates.AtesCF.explain" class="md-nav__link">
    explain()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#TSInterpret.InterpretabilityModels.counterfactual.Ates.AtesCF.plot" class="md-nav__link">
    plot()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#TSInterpret.InterpretabilityModels.counterfactual.Ates.BaseExplanation" class="md-nav__link">
    BaseExplanation
  </a>
  
    <nav class="md-nav" aria-label="BaseExplanation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#TSInterpret.InterpretabilityModels.counterfactual.Ates.BaseExplanation.construct_per_class_trees" class="md-nav__link">
    construct_per_class_trees()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#TSInterpret.InterpretabilityModels.counterfactual.Ates.BaseExplanation.local_lipschitz_estimate" class="md-nav__link">
    local_lipschitz_estimate()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#TSInterpret.InterpretabilityModels.counterfactual.Ates.LossDiscreteState" class="md-nav__link">
    LossDiscreteState
  </a>
  
    <nav class="md-nav" aria-label="LossDiscreteState">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#TSInterpret.InterpretabilityModels.counterfactual.Ates.LossDiscreteState.get_prob_type" class="md-nav__link">
    get_prob_type()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  
                
                
                  <h1>CF</h1>
                
                <div class="doc doc-object doc-module">

<a id="TSInterpret.InterpretabilityModels.counterfactual.CF"></a>
    <div class="doc doc-contents first">




  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h2 class="doc doc-heading" id="TSInterpret.InterpretabilityModels.counterfactual.CF.CF">
        <code>
CF            (<a class="autorefs autorefs-internal" title="TSInterpret.InterpretabilityModels.InterpretabilityBase.InterpretabilityBase" href="../../InterpretabilityMethods/#TSInterpret.InterpretabilityModels.InterpretabilityBase.InterpretabilityBase">InterpretabilityBase</a>)
        </code>



</h2>

    <div class="doc doc-contents ">

      <p>Abstract class to implement Coutnterfactual Methods for time series data 
model: Machine Learning Model to be explained.
mode : Second dimension is feature --&gt; 'feat', is time --&gt; 'time'</p>

        <details class="quote">
          <summary>Source code in <code>counterfactual/CF.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">CF</span><span class="p">(</span><span class="n">InterpretabilityBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract class to implement Coutnterfactual Methods for time series data </span>
<span class="sd">    model: Machine Learning Model to be explained.</span>
<span class="sd">    mode : Second dimension is feature --&gt; &#39;feat&#39;, is time --&gt; &#39;time&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mlmodel</span><span class="p">,</span><span class="n">mode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">mlmodel</span><span class="p">)</span>
        <span class="c1">#self.model_to_explain = mlmodel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="o">=</span><span class="n">mode</span>

    <span class="k">def</span> <span class="nf">explain</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Explains instance or model. </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        instance: np.array</span>
<span class="sd">            Not encoded and not normalised factual examples in two-dimensional shape (m, n).</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Tuple(cf, label)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Please don&#39;t use the base class directly&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">original</span><span class="p">,</span><span class="n">org_label</span><span class="p">,</span> <span class="n">exp</span><span class="p">,</span><span class="n">exp_label</span><span class="p">,</span> <span class="n">vis_change</span><span class="o">=</span> <span class="kc">True</span><span class="p">,</span><span class="n">all_in_one</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Basic Plot Function for visualizing Coutnerfactuals.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        instance: np.array</span>
<span class="sd">            Not encoded and not normalised factual examples in two-dimensional shape (m, n).</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            Encoded and normalised counterfactual examples.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">all_in_one</span><span class="p">:</span>
            <span class="n">ax011</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ax012</span> <span class="o">=</span> <span class="n">ax011</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
            <span class="n">sal_02</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">original</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">vis_change</span><span class="p">:</span>
                <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">sal_02</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">cbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax011</span><span class="p">,</span> <span class="n">yticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">sal_02</span><span class="p">),</span><span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">cbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax011</span><span class="p">,</span> <span class="n">yticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">original</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))),</span> <span class="n">y</span><span class="o">=</span><span class="n">original</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax012</span><span class="p">,</span><span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Original&#39;</span><span class="p">)</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">original</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))),</span> <span class="n">y</span><span class="o">=</span><span class="n">exp</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax012</span><span class="p">,</span><span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Counterfactual&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax011</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ax012</span> <span class="o">=</span> <span class="n">ax011</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
            <span class="n">sal_02</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">original</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">vis_change</span><span class="p">:</span>
                <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">sal_02</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">cbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax011</span><span class="p">,</span> <span class="n">yticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">sal_02</span><span class="p">),</span><span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">cbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax011</span><span class="p">,</span> <span class="n">yticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">p</span><span class="o">=</span><span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">original</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))),</span> <span class="n">y</span><span class="o">=</span><span class="n">original</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax012</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">org_label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Original&quot;</span><span class="p">)</span>

            <span class="n">ax031</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">ax032</span> <span class="o">=</span> <span class="n">ax031</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
            <span class="n">sal_02</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">original</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">vis_change</span><span class="p">:</span>
                <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">sal_02</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">cbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax031</span><span class="p">,</span> <span class="n">yticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">sal_02</span><span class="p">),</span><span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">cbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax011</span><span class="p">,</span> <span class="n">yticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">p</span><span class="o">=</span><span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">original</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))),</span> <span class="n">y</span><span class="o">=</span><span class="n">exp</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax032</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">exp_label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Counterfactual&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">save</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot_in_one</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">item</span><span class="p">,</span><span class="n">org_label</span><span class="p">,</span><span class="n">exp</span><span class="p">,</span><span class="n">cf_label</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Basic Plot Function for Visualizing Coutnerfactuals.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        instance: np.array</span>
<span class="sd">            Not encoded and not normalised factual examples in two-dimensional shape (m, n).</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            Encoded and normalised counterfactual examples.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;classic&quot;</span><span class="p">)</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;#08F7FE&#39;</span><span class="p">,</span>  <span class="c1"># teal/cyan</span>
            <span class="s1">&#39;#FE53BB&#39;</span><span class="p">,</span>  <span class="c1"># pink</span>
            <span class="s1">&#39;#F5D300&#39;</span><span class="p">,</span>  <span class="c1"># yellow</span>
            <span class="s1">&#39;#00ff41&#39;</span><span class="p">,</span>  <span class="c1"># matrix green</span>
        <span class="p">]</span>
        <span class="n">indices</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">exp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">item</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="sa">f</span><span class="s1">&#39;Predicted: </span><span class="si">{</span><span class="n">org_label</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">flatten</span><span class="p">()),</span>
                   <span class="sa">f</span><span class="s1">&#39;Counterfactual: </span><span class="si">{</span><span class="n">cf_label</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">exp</span><span class="o">.</span><span class="n">flatten</span><span class="p">())})</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
        <span class="n">df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="c1"># Redraw the data with low alpha and slighty increased linewidth:</span>
        <span class="n">n_shades</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">diff_linewidth</span> <span class="o">=</span> <span class="mf">1.05</span>
        <span class="n">alpha_value</span> <span class="o">=</span> <span class="mf">0.3</span> <span class="o">/</span> <span class="n">n_shades</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_shades</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">diff_linewidth</span><span class="o">*</span><span class="n">n</span><span class="p">),</span>
            <span class="n">alpha</span><span class="o">=</span><span class="n">alpha_value</span><span class="p">,</span>
            <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;#2A3459&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time&#39;</span><span class="p">,</span> <span class="n">fontweight</span> <span class="o">=</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;large&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value&#39;</span><span class="p">,</span> <span class="n">fontweight</span> <span class="o">=</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;large&#39;</span><span class="p">)</span>
        <span class="c1">#plt.savefig(&#39;../Images/Initial_Example_Neon.pdf&#39;)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">










  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="TSInterpret.InterpretabilityModels.counterfactual.CF.CF.explain">
<code class="highlight language-python"><span class="n">explain</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Explains instance or model. 
Parameters</p>
<hr />
<p>!!! instance "np.array"
    Not encoded and not normalised factual examples in two-dimensional shape (m, n).
Returns</p>
<hr />
<p>Tuple(cf, label)</p>

        <details class="quote">
          <summary>Source code in <code>counterfactual/CF.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">explain</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Explains instance or model. </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    instance: np.array</span>
<span class="sd">        Not encoded and not normalised factual examples in two-dimensional shape (m, n).</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Tuple(cf, label)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Please don&#39;t use the base class directly&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="TSInterpret.InterpretabilityModels.counterfactual.CF.CF.plot">
<code class="highlight language-python"><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">original</span><span class="p">,</span> <span class="n">org_label</span><span class="p">,</span> <span class="n">exp</span><span class="p">,</span> <span class="n">exp_label</span><span class="p">,</span> <span class="n">vis_change</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">all_in_one</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Basic Plot Function for visualizing Coutnerfactuals.
Parameters</p>
<hr />
<p>!!! instance "np.array"
    Not encoded and not normalised factual examples in two-dimensional shape (m, n).
Returns</p>
<hr />
<p>pd.DataFrame
    Encoded and normalised counterfactual examples.</p>

        <details class="quote">
          <summary>Source code in <code>counterfactual/CF.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">plot</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">original</span><span class="p">,</span><span class="n">org_label</span><span class="p">,</span> <span class="n">exp</span><span class="p">,</span><span class="n">exp_label</span><span class="p">,</span> <span class="n">vis_change</span><span class="o">=</span> <span class="kc">True</span><span class="p">,</span><span class="n">all_in_one</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Basic Plot Function for visualizing Coutnerfactuals.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    instance: np.array</span>
<span class="sd">        Not encoded and not normalised factual examples in two-dimensional shape (m, n).</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        Encoded and normalised counterfactual examples.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">all_in_one</span><span class="p">:</span>
        <span class="n">ax011</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ax012</span> <span class="o">=</span> <span class="n">ax011</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
        <span class="n">sal_02</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">original</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">vis_change</span><span class="p">:</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">sal_02</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">cbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax011</span><span class="p">,</span> <span class="n">yticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">sal_02</span><span class="p">),</span><span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">cbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax011</span><span class="p">,</span> <span class="n">yticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">original</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))),</span> <span class="n">y</span><span class="o">=</span><span class="n">original</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax012</span><span class="p">,</span><span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Original&#39;</span><span class="p">)</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">original</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))),</span> <span class="n">y</span><span class="o">=</span><span class="n">exp</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax012</span><span class="p">,</span><span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Counterfactual&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax011</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ax012</span> <span class="o">=</span> <span class="n">ax011</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
        <span class="n">sal_02</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">original</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">vis_change</span><span class="p">:</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">sal_02</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">cbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax011</span><span class="p">,</span> <span class="n">yticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">sal_02</span><span class="p">),</span><span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">cbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax011</span><span class="p">,</span> <span class="n">yticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">p</span><span class="o">=</span><span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">original</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))),</span> <span class="n">y</span><span class="o">=</span><span class="n">original</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax012</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">org_label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Original&quot;</span><span class="p">)</span>

        <span class="n">ax031</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ax032</span> <span class="o">=</span> <span class="n">ax031</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
        <span class="n">sal_02</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">original</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">vis_change</span><span class="p">:</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">sal_02</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">cbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax031</span><span class="p">,</span> <span class="n">yticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">sal_02</span><span class="p">),</span><span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">cbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax011</span><span class="p">,</span> <span class="n">yticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">p</span><span class="o">=</span><span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">original</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))),</span> <span class="n">y</span><span class="o">=</span><span class="n">exp</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax032</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">exp_label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Counterfactual&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">save</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span> 
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="TSInterpret.InterpretabilityModels.counterfactual.CF.CF.plot_in_one">
<code class="highlight language-python"><span class="n">plot_in_one</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">org_label</span><span class="p">,</span> <span class="n">exp</span><span class="p">,</span> <span class="n">cf_label</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Basic Plot Function for Visualizing Coutnerfactuals.
Parameters</p>
<hr />
<p>!!! instance "np.array"
    Not encoded and not normalised factual examples in two-dimensional shape (m, n).
Returns</p>
<hr />
<p>pd.DataFrame
    Encoded and normalised counterfactual examples.</p>

        <details class="quote">
          <summary>Source code in <code>counterfactual/CF.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">plot_in_one</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">item</span><span class="p">,</span><span class="n">org_label</span><span class="p">,</span><span class="n">exp</span><span class="p">,</span><span class="n">cf_label</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Basic Plot Function for Visualizing Coutnerfactuals.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    instance: np.array</span>
<span class="sd">        Not encoded and not normalised factual examples in two-dimensional shape (m, n).</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        Encoded and normalised counterfactual examples.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;classic&quot;</span><span class="p">)</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;#08F7FE&#39;</span><span class="p">,</span>  <span class="c1"># teal/cyan</span>
        <span class="s1">&#39;#FE53BB&#39;</span><span class="p">,</span>  <span class="c1"># pink</span>
        <span class="s1">&#39;#F5D300&#39;</span><span class="p">,</span>  <span class="c1"># yellow</span>
        <span class="s1">&#39;#00ff41&#39;</span><span class="p">,</span>  <span class="c1"># matrix green</span>
    <span class="p">]</span>
    <span class="n">indices</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">exp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">item</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="sa">f</span><span class="s1">&#39;Predicted: </span><span class="si">{</span><span class="n">org_label</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">flatten</span><span class="p">()),</span>
               <span class="sa">f</span><span class="s1">&#39;Counterfactual: </span><span class="si">{</span><span class="n">cf_label</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">exp</span><span class="o">.</span><span class="n">flatten</span><span class="p">())})</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
    <span class="n">df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
    <span class="c1"># Redraw the data with low alpha and slighty increased linewidth:</span>
    <span class="n">n_shades</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">diff_linewidth</span> <span class="o">=</span> <span class="mf">1.05</span>
    <span class="n">alpha_value</span> <span class="o">=</span> <span class="mf">0.3</span> <span class="o">/</span> <span class="n">n_shades</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_shades</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span>
        <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">diff_linewidth</span><span class="o">*</span><span class="n">n</span><span class="p">),</span>
        <span class="n">alpha</span><span class="o">=</span><span class="n">alpha_value</span><span class="p">,</span>
        <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;#2A3459&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time&#39;</span><span class="p">,</span> <span class="n">fontweight</span> <span class="o">=</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;large&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value&#39;</span><span class="p">,</span> <span class="n">fontweight</span> <span class="o">=</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;large&#39;</span><span class="p">)</span>
    <span class="c1">#plt.savefig(&#39;../Images/Initial_Example_Neon.pdf&#39;)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">

<a id="TSInterpret.InterpretabilityModels.counterfactual.NativeGuideCF"></a>
    <div class="doc doc-contents first">

      <p>Implementation after Delaney et al . https://github.com/e-delaney/Instance-Based_CFE_TSC</p>



  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h2 class="doc doc-heading" id="TSInterpret.InterpretabilityModels.counterfactual.NativeGuideCF.NativeGuideCF">
        <code>
NativeGuideCF            (<a class="autorefs autorefs-internal" title="TSInterpret.InterpretabilityModels.counterfactual.CF.CF" href="#TSInterpret.InterpretabilityModels.counterfactual.CF.CF">CF</a>)
        </code>



</h2>

    <div class="doc doc-contents ">

      <p>NUN_CF according to 
Delaney, E., Greene, D., Keane, M.T.: Instance-Based Counterfactual Explanations
for Time Series Classification. In: S Ìanchez-Ruiz, A.A., Floyd, M.W. (eds.) Case-
Based Reasoning Research and Development, vol. 12877, pp. 32â47. Springer
International Publishing, Cham (2021), series Title: Lecture Notes in Computer
Science     for both torch and tensorflow. </p>

        <details class="quote">
          <summary>Source code in <code>counterfactual/NativeGuideCF.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">NativeGuideCF</span><span class="p">(</span><span class="n">CF</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    NUN_CF according to </span>
<span class="sd">    Delaney, E., Greene, D., Keane, M.T.: Instance-Based Counterfactual Explanations</span>
<span class="sd">    for Time Series Classification. In: S Ìanchez-Ruiz, A.A., Floyd, M.W. (eds.) Case-</span>
<span class="sd">    Based Reasoning Research and Development, vol. 12877, pp. 32â47. Springer</span>
<span class="sd">    International Publishing, Cham (2021), series Title: Lecture Notes in Computer</span>
<span class="sd">    Science     for both torch and tensorflow. </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span><span class="n">shape</span><span class="p">,</span> <span class="n">reference_set</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s1">&#39;torch&#39;</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span><span class="s1">&#39;feat&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        In this case differentiation between time &amp; feat not necessary as implicitly given by CNN. Only works for CNNs due to the attribution methods.</span>
<span class="sd">        Args:</span>
<span class="sd">            model: classification model to explain</span>
<span class="sd">            shape: input shape</span>
<span class="sd">            reference set: reference set as tuple</span>
<span class="sd">            mode: model type either torch or tensorflow</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">mode</span><span class="p">)</span>
        <span class="c1">#self.model=model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">=</span><span class="n">backend</span>
        <span class="n">test_x</span><span class="p">,</span><span class="n">test_y</span><span class="o">=</span><span class="n">reference_set</span>
        <span class="n">test_x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">test_x</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="o">=</span><span class="n">mode</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span>
            <span class="c1">#Parse test data into (1, feat, time):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ts_length</span><span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">test_x</span><span class="o">=</span><span class="n">test_x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">test_x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">test_x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">test_x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;feat&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ts_length</span><span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">backend</span> <span class="o">==</span> <span class="s1">&#39;PYT&#39;</span><span class="p">:</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1">#self.cam_extractor =SmoothGradCAMpp(self.model,input_shape=(shape[1],shape[2]) )</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cam_extractor</span> <span class="o">=</span><span class="n">CAM</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span><span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;GradCam Hook already registered&#39;</span><span class="p">)</span>
            <span class="c1">#out=self.model(torch.from_numpy(test_x.reshape(-1,1,test_x.shape[-1])))</span>
            <span class="n">change</span><span class="o">=</span><span class="kc">False</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span><span class="s1">&#39;time&#39;</span><span class="p">:</span>
                <span class="n">change</span><span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="o">=</span><span class="n">PyTorchModel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span><span class="n">change</span><span class="p">)</span><span class="o">.</span><span class="n">predict</span>
            <span class="n">y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_x</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">backend</span><span class="o">==</span> <span class="s1">&#39;TF&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cam_extractor</span> <span class="o">=</span><span class="n">GradCam1D</span><span class="p">()</span> <span class="c1">#VanillaGradients()#GradCam1D()</span>
            <span class="n">y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ts_length</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="o">=</span><span class="n">TensorFlowModel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span><span class="n">change</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">predict</span>
            <span class="c1">#Parse test data into torch format : </span>

        <span class="k">else</span><span class="p">:</span> 
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Only Compatible with Tensorflow (TF) or Pytorch (PYT)!&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reference_set</span><span class="o">=</span><span class="p">(</span><span class="n">test_x</span><span class="p">,</span><span class="n">y_pred</span><span class="p">)</span>
        <span class="c1">#Manipulate reference set replace original y with predicted y </span>

    <span class="k">def</span> <span class="nf">native_guide_retrieval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">query</span><span class="p">,</span> <span class="n">predicted_label</span><span class="p">,</span> <span class="n">distance</span><span class="p">,</span> <span class="n">n_neighbors</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        This gets the nearest unlike neighbors.</span>
<span class="sd">        Args:</span>
<span class="sd">            query (np.array): The instance to explain.</span>
<span class="sd">            predicted_label (np.array): Label of instance.</span>
<span class="sd">            reference_set (np.array): Set of addtional labeled data (could be training or test set)</span>
<span class="sd">            distance (str): </span>
<span class="sd">            num_neighbors (int):number nearest neighbors to return</span>
<span class="sd">        Returns:</span>
<span class="sd">            [np.array]: Returns K_Nearest_Neighbors of input query with different classification label.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">predicted_label</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">:</span>
            <span class="n">predicted_label</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">predicted_label</span><span class="p">)</span>

        <span class="n">x_train</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_set</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ts_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ts_length</span>
        <span class="n">knn</span> <span class="o">=</span> <span class="n">KNeighborsTimeSeries</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="n">n_neighbors</span><span class="p">,</span> <span class="n">metric</span> <span class="o">=</span> <span class="n">distance</span><span class="p">)</span>
        <span class="n">knn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y</span> <span class="o">!=</span> <span class="n">predicted_label</span><span class="p">))]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">ts_length</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">dist</span><span class="p">,</span><span class="n">ind</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">kneighbors</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">ts_length</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">return_distance</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">x_train</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">ts_length</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">x_train</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y</span> <span class="o">!=</span> <span class="n">predicted_label</span><span class="p">)][</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

    <span class="k">def</span> <span class="nf">findSubarray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="c1">#used to find the maximum contigious subarray of length k in the explanation weight vector</span>

        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

        <span class="n">vec</span><span class="o">=</span><span class="p">[]</span> 

        <span class="c1"># Iterate to find all the sub-arrays </span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span> 
            <span class="n">temp</span><span class="o">=</span><span class="p">[]</span> 

            <span class="c1"># Store the sub-array elements in the array </span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="n">k</span><span class="p">):</span> 
                <span class="n">temp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> 

            <span class="c1"># Push the vector in the container </span>
            <span class="n">vec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span> 

        <span class="n">sum_arr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vec</span><span class="p">:</span>
            <span class="n">sum_arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">vec</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">sum_arr</span><span class="p">)])</span>

    <span class="k">def</span> <span class="nf">counterfactual_generator_swap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">instance</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span><span class="n">subarray_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span><span class="n">nun</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">native_guide_retrieval</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="s1">&#39;euclidean&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">nun</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">instance</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Starting and nun are Identical !&#39;</span><span class="p">)</span>

        <span class="n">test_x</span><span class="p">,</span><span class="n">test_y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_set</span>
        <span class="n">train_x</span><span class="o">=</span><span class="n">test_x</span>

        <span class="c1">#Classify native guide</span>
        <span class="c1">#input_ = torch.from_numpy(np.array(nun)).float().reshape(-1,1,train_x.shape[-1])</span>
        <span class="c1">#out = torch.nn.functional.softmax(self.model(input_)).detach().numpy()</span>
        <span class="n">individual</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nun</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">individual</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Native Guide&#39;</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">==</span><span class="s1">&#39;PYT&#39;</span><span class="p">:</span> 
            <span class="n">training_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cam_extractor</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">out</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">==</span><span class="s1">&#39;TF&#39;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
            <span class="c1">#label= tf.Tensor([[0,0,0,0,1,0,0,0,0,0]],dtype=tf.int32)</span>
            <span class="n">training_weights</span> <span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cam_extractor</span><span class="o">.</span><span class="n">explain</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span><span class="n">class_index</span><span class="o">=</span><span class="n">label</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="c1"># grad_cam(self.model, instance.reshape(1,-1,1))#self.cam_extractor.explain(data, self.model,class_index=label)#instance</span>
        <span class="c1">#Classify Original</span>
        <span class="n">individual</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">individual</span><span class="p">)</span>
        <span class="c1">#input_ = torch.from_numpy(np.array(instance)).float().reshape(-1,1,train_x.shape[-1]) </span>
        <span class="c1">#out = torch.nn.functional.softmax(self.model(input_)).detach().numpy()</span>


        <span class="n">most_influencial_array</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">findSubarray</span><span class="p">((</span><span class="n">training_weights</span><span class="p">),</span> <span class="n">subarray_length</span><span class="p">)</span>

        <span class="n">starting_point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">training_weights</span><span class="o">==</span><span class="n">most_influencial_array</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Starting Points&#39;</span><span class="p">,</span> <span class="n">starting_point</span><span class="p">)</span>

        <span class="n">X_example</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">nun</span><span class="o">=</span><span class="n">nun</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Subarray Length&#39;</span><span class="p">,</span> <span class="n">subarray_length</span><span class="p">)</span>
        <span class="n">X_example</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">starting_point</span><span class="p">:</span><span class="n">subarray_length</span><span class="o">+</span><span class="n">starting_point</span><span class="p">]</span> <span class="o">=</span><span class="n">nun</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">starting_point</span><span class="p">:</span><span class="n">subarray_length</span><span class="o">+</span><span class="n">starting_point</span><span class="p">]</span>
        <span class="c1">#np.concatenate(instance[:starting_point], nun[starting_point:subarray_length+starting_point], instance[subarray_length+starting_point:])</span>
        <span class="c1">#print(np.argmax(label,axis=0))</span>
        <span class="n">individual</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X_example</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">train_x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">individual</span><span class="p">)</span>
        <span class="c1">#input_ = torch.from_numpy(np.array(X_example)).float().reshape(-1,1,train_x.shape[-1]) </span>
        <span class="c1">#out = torch.nn.functional.softmax(self.model(input_)).detach().numpy()</span>
        <span class="n">prob_target</span> <span class="o">=</span>  <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">label</span><span class="p">]</span> <span class="c1">#torch.nn.functional.softmax(model(torch.from_numpy(test_x))).detach().numpy()[0][y_pred[instance]]</span>
        <span class="c1">#print(out)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Prob_target&#39;</span><span class="p">,</span><span class="n">prob_target</span><span class="p">)</span>
        <span class="n">counter</span><span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">prob_target</span> <span class="o">&gt;</span> <span class="mf">0.5</span> <span class="ow">and</span> <span class="n">counter</span> <span class="o">&lt;</span><span class="n">max_iter</span><span class="p">:</span>

            <span class="n">subarray_length</span> <span class="o">+=</span><span class="mi">1</span>        
            <span class="n">most_influencial_array</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">findSubarray</span><span class="p">((</span><span class="n">training_weights</span><span class="p">),</span> <span class="n">subarray_length</span><span class="p">)</span>
            <span class="n">starting_point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">training_weights</span><span class="o">==</span><span class="n">most_influencial_array</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;starting&#39;</span><span class="p">,</span><span class="n">starting_point</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">subarray_length</span><span class="p">)</span>
            <span class="n">X_example</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">X_example</span><span class="p">[:,</span><span class="n">starting_point</span><span class="p">:</span><span class="n">subarray_length</span><span class="o">+</span><span class="n">starting_point</span><span class="p">]</span> <span class="o">=</span><span class="n">nun</span><span class="p">[:,</span><span class="n">starting_point</span><span class="p">:</span><span class="n">subarray_length</span><span class="o">+</span><span class="n">starting_point</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">nun</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">X_example</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">individual</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X_example</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">train_x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="n">out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">individual</span><span class="p">)</span>
            <span class="c1">#input_ = torch.from_numpy(np.array(X_example)).float().reshape(-1,1,train_x.shape[-1]) #TODO nun or instance</span>
            <span class="c1">#out = torch.nn.functional.softmax(self.model(input_)).detach().numpy()</span>
            <span class="n">prob_target</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">label</span><span class="p">]</span>
            <span class="c1">#print(out)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Prob_target&#39;</span><span class="p">,</span><span class="n">prob_target</span><span class="p">)</span>
            <span class="n">counter</span><span class="o">=</span><span class="n">counter</span><span class="o">+</span><span class="mi">1</span>
            <span class="k">if</span> <span class="n">counter</span><span class="o">==</span><span class="n">max_iter</span> <span class="ow">or</span> <span class="n">subarray_length</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">ts_length</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No Counterfactual found&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">X_example</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">instance_based_cf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">query</span><span class="p">,</span><span class="n">label</span><span class="p">,</span><span class="n">target</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="s1">&#39;dtw&#39;</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>

        <span class="n">d</span><span class="p">,</span><span class="n">nan</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">native_guide_retrieval</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">distance</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1">#TODO reshape</span>
        <span class="n">insample_cf</span> <span class="o">=</span> <span class="n">nan</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">individual</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

        <span class="n">output</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">individual</span><span class="p">)</span>
        <span class="c1">#input_ = torch.from_numpy(individual).float().reshape(1,1,-1)</span>
        <span class="c1">#output = torch.nn.functional.softmax(self.model(input_)).detach().numpy()</span>
        <span class="n">pred_treshold</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">output</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> 
        <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">insample_cf</span><span class="o">=</span><span class="n">insample_cf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">generated_cf</span> <span class="o">=</span> <span class="n">dtw_barycenter_averaging</span><span class="p">([</span><span class="n">query</span><span class="p">,</span> <span class="n">insample_cf</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="mi">1</span><span class="o">-</span><span class="n">beta</span><span class="p">),</span> <span class="n">beta</span><span class="p">]))</span>
        <span class="n">generated_cf</span> <span class="o">=</span> <span class="n">generated_cf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">individual</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">generated_cf</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">prob_target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">individual</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="n">target</span><span class="p">]</span>
        <span class="c1">#input_ = torch.from_numpy(individual).float().reshape(1,1,-1)</span>
        <span class="c1">#prob_target = torch.nn.functional.softmax(self.model(input_)).detach().numpy()[0][target]</span>
        <span class="n">counter</span><span class="o">=</span><span class="mi">0</span>

        <span class="k">while</span> <span class="n">prob_target</span> <span class="o">&lt;</span> <span class="n">pred_treshold</span> <span class="ow">and</span> <span class="n">counter</span><span class="o">&lt;</span><span class="n">max_iter</span><span class="p">:</span>
            <span class="n">beta</span> <span class="o">+=</span><span class="mf">0.01</span> 
            <span class="n">generated_cf</span><span class="o">=</span> <span class="n">dtw_barycenter_averaging</span><span class="p">([</span><span class="n">query</span><span class="p">,</span> <span class="n">insample_cf</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="mi">1</span><span class="o">-</span><span class="n">beta</span><span class="p">),</span> <span class="n">beta</span><span class="p">]))</span>
            <span class="n">generated_cf</span> <span class="o">=</span> <span class="n">generated_cf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">individual</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">generated_cf</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="c1">#input_ = torch.from_numpy(individual).float().reshape(1,1,-1)</span>
            <span class="c1">#prob_target = torch.nn.functional.softmax(self.model(input_)).detach().numpy()[0][target]</span>
            <span class="n">prob_target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">individual</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="n">target</span><span class="p">]</span>

            <span class="n">counter</span><span class="o">=</span><span class="n">counter</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">counter</span><span class="o">==</span><span class="n">max_iter</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No Counterfactual found&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">generated_cf</span><span class="p">,</span> <span class="n">target</span>

    <span class="c1">#TODO Output type </span>
    <span class="k">def</span> <span class="nf">explain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>  <span class="n">y</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;NUN_CF&#39;</span><span class="p">,</span> <span class="n">distance_measure</span><span class="o">=</span><span class="s1">&#39;dtw&#39;</span><span class="p">,</span><span class="n">n_neighbors</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span><span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="sd">&#39;&#39;&#39;&#39;</span>
<span class="sd">        Explains a specific instance x </span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span><span class="s1">&#39;time&#39;</span><span class="p">:</span>
            <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">method</span><span class="o">==</span><span class="s1">&#39;NUN_CF&#39;</span><span class="p">:</span>
            <span class="n">dis</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">native_guide_retrieval</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">distance_measure</span><span class="p">,</span> <span class="n">n_neighbors</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">item</span>
        <span class="k">elif</span> <span class="n">method</span><span class="o">==</span><span class="s1">&#39;dtw_bary_center&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance_based_cf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">distance_measure</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span><span class="o">==</span><span class="s1">&#39;native_guide&#39;</span><span class="p">:</span>
            <span class="n">distance_measure</span><span class="o">=</span><span class="s1">&#39;euclidean&#39;</span>
            <span class="k">return</span>  <span class="bp">self</span><span class="o">.</span><span class="n">counterfactual_generator_swap</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span><span class="n">max_iter</span><span class="o">=</span><span class="n">max_iter</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Unknown Method selected.&#39;</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="TSInterpret.InterpretabilityModels.counterfactual.NativeGuideCF.NativeGuideCF.__init__">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">reference_set</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s1">&#39;torch&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;feat&#39;</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

</h3>

    <div class="doc doc-contents ">

      <p>In this case differentiation between time &amp; feat not necessary as implicitly given by CNN. Only works for CNNs due to the attribution methods.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>model</code></td>
        <td></td>
        <td><p>classification model to explain</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>shape</code></td>
        <td></td>
        <td><p>input shape</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>reference</code></td>
        <td><code>set</code></td>
        <td><p>reference set as tuple</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>mode</code></td>
        <td></td>
        <td><p>model type either torch or tensorflow</p></td>
        <td><code>&#39;feat&#39;</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>counterfactual/NativeGuideCF.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span><span class="n">shape</span><span class="p">,</span> <span class="n">reference_set</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s1">&#39;torch&#39;</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span><span class="s1">&#39;feat&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    In this case differentiation between time &amp; feat not necessary as implicitly given by CNN. Only works for CNNs due to the attribution methods.</span>
<span class="sd">    Args:</span>
<span class="sd">        model: classification model to explain</span>
<span class="sd">        shape: input shape</span>
<span class="sd">        reference set: reference set as tuple</span>
<span class="sd">        mode: model type either torch or tensorflow</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">mode</span><span class="p">)</span>
    <span class="c1">#self.model=model</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">=</span><span class="n">backend</span>
    <span class="n">test_x</span><span class="p">,</span><span class="n">test_y</span><span class="o">=</span><span class="n">reference_set</span>
    <span class="n">test_x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">test_x</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="o">=</span><span class="n">mode</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span>
        <span class="c1">#Parse test data into (1, feat, time):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ts_length</span><span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">test_x</span><span class="o">=</span><span class="n">test_x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">test_x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">test_x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">test_x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;feat&#39;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ts_length</span><span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">backend</span> <span class="o">==</span> <span class="s1">&#39;PYT&#39;</span><span class="p">:</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1">#self.cam_extractor =SmoothGradCAMpp(self.model,input_shape=(shape[1],shape[2]) )</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cam_extractor</span> <span class="o">=</span><span class="n">CAM</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span><span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;GradCam Hook already registered&#39;</span><span class="p">)</span>
        <span class="c1">#out=self.model(torch.from_numpy(test_x.reshape(-1,1,test_x.shape[-1])))</span>
        <span class="n">change</span><span class="o">=</span><span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span><span class="s1">&#39;time&#39;</span><span class="p">:</span>
            <span class="n">change</span><span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="o">=</span><span class="n">PyTorchModel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span><span class="n">change</span><span class="p">)</span><span class="o">.</span><span class="n">predict</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_x</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">backend</span><span class="o">==</span> <span class="s1">&#39;TF&#39;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cam_extractor</span> <span class="o">=</span><span class="n">GradCam1D</span><span class="p">()</span> <span class="c1">#VanillaGradients()#GradCam1D()</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ts_length</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="o">=</span><span class="n">TensorFlowModel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span><span class="n">change</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">predict</span>
        <span class="c1">#Parse test data into torch format : </span>

    <span class="k">else</span><span class="p">:</span> 
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Only Compatible with Tensorflow (TF) or Pytorch (PYT)!&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">reference_set</span><span class="o">=</span><span class="p">(</span><span class="n">test_x</span><span class="p">,</span><span class="n">y_pred</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>




  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="TSInterpret.InterpretabilityModels.counterfactual.NativeGuideCF.NativeGuideCF.explain">
<code class="highlight language-python"><span class="n">explain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;NUN_CF&#39;</span><span class="p">,</span> <span class="n">distance_measure</span><span class="o">=</span><span class="s1">&#39;dtw&#39;</span><span class="p">,</span> <span class="n">n_neighbors</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>'
Explains a specific instance x </p>

        <details class="quote">
          <summary>Source code in <code>counterfactual/NativeGuideCF.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">explain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>  <span class="n">y</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;NUN_CF&#39;</span><span class="p">,</span> <span class="n">distance_measure</span><span class="o">=</span><span class="s1">&#39;dtw&#39;</span><span class="p">,</span><span class="n">n_neighbors</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span><span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
    <span class="sd">&#39;&#39;&#39;&#39;</span>
<span class="sd">    Explains a specific instance x </span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span><span class="s1">&#39;time&#39;</span><span class="p">:</span>
        <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">method</span><span class="o">==</span><span class="s1">&#39;NUN_CF&#39;</span><span class="p">:</span>
        <span class="n">dis</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">native_guide_retrieval</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">distance_measure</span><span class="p">,</span> <span class="n">n_neighbors</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">item</span>
    <span class="k">elif</span> <span class="n">method</span><span class="o">==</span><span class="s1">&#39;dtw_bary_center&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance_based_cf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">distance_measure</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span><span class="o">==</span><span class="s1">&#39;native_guide&#39;</span><span class="p">:</span>
        <span class="n">distance_measure</span><span class="o">=</span><span class="s1">&#39;euclidean&#39;</span>
        <span class="k">return</span>  <span class="bp">self</span><span class="o">.</span><span class="n">counterfactual_generator_swap</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span><span class="n">max_iter</span><span class="o">=</span><span class="n">max_iter</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> 
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Unknown Method selected.&#39;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="TSInterpret.InterpretabilityModels.counterfactual.NativeGuideCF.NativeGuideCF.native_guide_retrieval">
<code class="highlight language-python"><span class="n">native_guide_retrieval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">predicted_label</span><span class="p">,</span> <span class="n">distance</span><span class="p">,</span> <span class="n">n_neighbors</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>This gets the nearest unlike neighbors.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>query</code></td>
        <td><code>np.array</code></td>
        <td><p>The instance to explain.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>predicted_label</code></td>
        <td><code>np.array</code></td>
        <td><p>Label of instance.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>reference_set</code></td>
        <td><code>np.array</code></td>
        <td><p>Set of addtional labeled data (could be training or test set)</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>distance</code></td>
        <td><code>str</code></td>
        <td></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>num_neighbors</code></td>
        <td><code>int</code></td>
        <td><p>number nearest neighbors to return</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>[np.array]</code></td>
      <td><p>Returns K_Nearest_Neighbors of input query with different classification label.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>counterfactual/NativeGuideCF.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">native_guide_retrieval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">query</span><span class="p">,</span> <span class="n">predicted_label</span><span class="p">,</span> <span class="n">distance</span><span class="p">,</span> <span class="n">n_neighbors</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This gets the nearest unlike neighbors.</span>
<span class="sd">    Args:</span>
<span class="sd">        query (np.array): The instance to explain.</span>
<span class="sd">        predicted_label (np.array): Label of instance.</span>
<span class="sd">        reference_set (np.array): Set of addtional labeled data (could be training or test set)</span>
<span class="sd">        distance (str): </span>
<span class="sd">        num_neighbors (int):number nearest neighbors to return</span>
<span class="sd">    Returns:</span>
<span class="sd">        [np.array]: Returns K_Nearest_Neighbors of input query with different classification label.</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">predicted_label</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">predicted_label</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">predicted_label</span><span class="p">)</span>

    <span class="n">x_train</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_set</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
        <span class="n">y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ts_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ts_length</span>
    <span class="n">knn</span> <span class="o">=</span> <span class="n">KNeighborsTimeSeries</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="n">n_neighbors</span><span class="p">,</span> <span class="n">metric</span> <span class="o">=</span> <span class="n">distance</span><span class="p">)</span>
    <span class="n">knn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y</span> <span class="o">!=</span> <span class="n">predicted_label</span><span class="p">))]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">ts_length</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">dist</span><span class="p">,</span><span class="n">ind</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">kneighbors</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">ts_length</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">return_distance</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">x_train</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">ts_length</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">x_train</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y</span> <span class="o">!=</span> <span class="n">predicted_label</span><span class="p">)][</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">

<a id="TSInterpret.InterpretabilityModels.counterfactual.Ates"></a>
    <div class="doc doc-contents first">

      <p>Contains the code for ICAPAI'21 paper "Counterfactual Explanations for Multivariate Time Series"
!!! authors
    Emre Ates (1), Burak Aksar (1), Vitus J. Leung (2), Ayse K. Coskun (1)
!!! affiliations
    (1) Department of Electrical and Computer Engineering, Boston University
    (2) Sandia National Laboratories
This work has been partially funded by Sandia National Laboratories. Sandia
National Laboratories is a multimission laboratory managed and operated by
National Technology and Engineering Solutions of Sandia, LLC., a wholly owned
subsidiary of Honeywell International, Inc., for the U.S. Department of
Energyâs National Nuclear Security Administration under Contract DENA0003525.</p>



  <div class="doc doc-children">










  <div class="doc doc-object doc-class">



<h2 class="doc doc-heading" id="TSInterpret.InterpretabilityModels.counterfactual.Ates.AtesCF">
        <code>
AtesCF            (<a class="autorefs autorefs-internal" title="TSInterpret.InterpretabilityModels.counterfactual.CF.CF" href="#TSInterpret.InterpretabilityModels.counterfactual.CF.CF">CF</a>)
        </code>



</h2>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>counterfactual/Ates.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">AtesCF</span><span class="p">(</span><span class="n">CF</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">mlmodel</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">backend</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1">#super().__init__()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">mlmodel</span><span class="p">,</span><span class="n">mode</span><span class="p">)</span>
        <span class="c1">#self.model_to_explain = mlmodel</span>
        <span class="c1">#self.mode = mode </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">=</span><span class="n">backend</span>
        <span class="n">test_x</span><span class="p">,</span><span class="n">test_y</span><span class="o">=</span><span class="n">ref</span>
        <span class="n">shape</span><span class="o">=</span><span class="n">test_x</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span>
            <span class="c1">#Parse test data into (1, feat, time):</span>
            <span class="n">change</span><span class="o">=</span><span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ts_length</span><span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">test_x</span><span class="o">=</span><span class="n">test_x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">test_x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">test_x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">test_x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;feat&#39;</span><span class="p">:</span>
            <span class="n">change</span><span class="o">=</span><span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ts_length</span><span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">backend</span><span class="o">==</span><span class="s1">&#39;PYT&#39;</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="o">=</span><span class="n">PyTorchModel</span><span class="p">(</span><span class="n">mlmodel</span><span class="p">,</span><span class="n">change</span><span class="p">)</span><span class="o">.</span><span class="n">predict</span>
        <span class="k">elif</span> <span class="n">backend</span> <span class="o">==</span> <span class="s1">&#39;TF&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="o">=</span><span class="n">TensorFlowModel</span><span class="p">(</span><span class="n">mlmodel</span><span class="p">,</span><span class="n">change</span><span class="p">)</span><span class="o">.</span><span class="n">predict</span>

        <span class="k">elif</span> <span class="n">backend</span> <span class="o">==</span> <span class="s1">&#39;SK&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="o">=</span><span class="n">SklearnModel</span><span class="p">(</span><span class="n">mlmodel</span><span class="p">,</span><span class="n">change</span><span class="p">)</span><span class="o">.</span><span class="n">predict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">referenceset</span><span class="o">=</span><span class="p">(</span><span class="n">test_x</span><span class="p">,</span><span class="n">test_y</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">explain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span> <span class="s1">&#39;opt&#39;</span><span class="p">)</span><span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Counterfactual according to Ates.</span>
<span class="sd">        Args:</span>
<span class="sd">            x (np.array): The instance to explain.</span>
<span class="sd">            target (np.array): target class.</span>

<span class="sd">        Returns:</span>
<span class="sd">            [np.array], int: Tuple of Counterfactual and Label</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="s1">&#39;feat&#39;</span><span class="p">:</span>
            <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>

        <span class="n">train_x</span><span class="p">,</span><span class="n">train_y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">referenceset</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
             <span class="n">train_y</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">train_y</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1">#print(train_x.shape)</span>
        <span class="k">if</span> <span class="n">method</span><span class="o">==</span><span class="s1">&#39;opt&#39;</span><span class="p">:</span>
            <span class="n">opt</span><span class="o">=</span><span class="n">OptimizedSearch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">,</span> <span class="n">train_x</span><span class="p">,</span> <span class="n">train_y</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">num_distractors</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">opt</span><span class="o">.</span><span class="n">explain</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">to_maximize</span><span class="o">=</span><span class="n">target</span><span class="p">,</span><span class="n">savefig</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span><span class="s1">&#39;brute&#39;</span><span class="p">:</span>
            <span class="n">opt</span><span class="o">=</span><span class="n">BruteForceSearch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">,</span> <span class="n">train_x</span><span class="p">,</span><span class="n">train_y</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">opt</span><span class="o">.</span><span class="n">explain</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">to_maximize</span><span class="o">=</span><span class="n">target</span><span class="p">,</span><span class="n">savefig</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">item</span><span class="p">,</span><span class="n">org_label</span><span class="p">,</span><span class="n">exp</span><span class="p">,</span><span class="n">cf_label</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">15</span><span class="p">)):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span>
            <span class="n">item</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">item</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">item</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> 

        <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;classic&quot;</span><span class="p">)</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;#08F7FE&#39;</span><span class="p">,</span>  <span class="c1"># teal/cyan</span>
            <span class="s1">&#39;#FE53BB&#39;</span><span class="p">,</span>  <span class="c1"># pink</span>
            <span class="s1">&#39;#F5D300&#39;</span><span class="p">,</span>  <span class="c1"># yellow</span>
            <span class="s1">&#39;#00ff41&#39;</span><span class="p">,</span>  <span class="c1"># matrix green</span>
        <span class="p">]</span>
        <span class="c1">#Figure out number changed channels</span>
        <span class="c1">#index= np.where(np.any(item))</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">item</span> <span class="o">!=</span> <span class="n">exp</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ind</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
        <span class="c1">#Draw changed channels</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="c1">#print(ax)</span>
        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="c1">#fig,ax=plt.subplot(len(ind[0]),1,i)</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="sa">f</span><span class="s1">&#39;Predicted: </span><span class="si">{</span><span class="n">org_label</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">channel</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()),</span>
                   <span class="sa">f</span><span class="s1">&#39;Counterfactual: </span><span class="si">{</span><span class="n">cf_label</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">exp</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">channel</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">())})</span>

            <span class="n">df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="c1"># Redraw the data with low alpha and slighty increased linewidth:</span>
            <span class="n">n_shades</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="n">diff_linewidth</span> <span class="o">=</span> <span class="mf">1.05</span>
            <span class="n">alpha_value</span> <span class="o">=</span> <span class="mf">0.3</span> <span class="o">/</span> <span class="n">n_shades</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_shades</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">diff_linewidth</span><span class="o">*</span><span class="n">n</span><span class="p">),</span>
                <span class="n">alpha</span><span class="o">=</span><span class="n">alpha_value</span><span class="p">,</span>
                <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">)</span>

            <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;#2A3459&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time&#39;</span><span class="p">,</span> <span class="n">fontweight</span> <span class="o">=</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;large&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value&#39;</span><span class="p">,</span> <span class="n">fontweight</span> <span class="o">=</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;large&#39;</span><span class="p">)</span>
            <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span>
        <span class="c1">#plt.savefig(&#39;../Images/Initial_Example_Neon.pdf&#39;)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">










  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="TSInterpret.InterpretabilityModels.counterfactual.Ates.AtesCF.explain">
<code class="highlight language-python"><span class="n">explain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;opt&#39;</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Counterfactual according to Ates.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>x</code></td>
        <td><code>np.array</code></td>
        <td><p>The instance to explain.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>target</code></td>
        <td><code>np.array</code></td>
        <td><p>target class.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>[np.array], int</code></td>
      <td><p>Tuple of Counterfactual and Label</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>counterfactual/Ates.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">explain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span> <span class="s1">&#39;opt&#39;</span><span class="p">)</span><span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Counterfactual according to Ates.</span>
<span class="sd">    Args:</span>
<span class="sd">        x (np.array): The instance to explain.</span>
<span class="sd">        target (np.array): target class.</span>

<span class="sd">    Returns:</span>
<span class="sd">        [np.array], int: Tuple of Counterfactual and Label</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="s1">&#39;feat&#39;</span><span class="p">:</span>
        <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>

    <span class="n">train_x</span><span class="p">,</span><span class="n">train_y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">referenceset</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
         <span class="n">train_y</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">train_y</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1">#print(train_x.shape)</span>
    <span class="k">if</span> <span class="n">method</span><span class="o">==</span><span class="s1">&#39;opt&#39;</span><span class="p">:</span>
        <span class="n">opt</span><span class="o">=</span><span class="n">OptimizedSearch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">,</span> <span class="n">train_x</span><span class="p">,</span> <span class="n">train_y</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">num_distractors</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">opt</span><span class="o">.</span><span class="n">explain</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">to_maximize</span><span class="o">=</span><span class="n">target</span><span class="p">,</span><span class="n">savefig</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span><span class="s1">&#39;brute&#39;</span><span class="p">:</span>
        <span class="n">opt</span><span class="o">=</span><span class="n">BruteForceSearch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">,</span> <span class="n">train_x</span><span class="p">,</span><span class="n">train_y</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">opt</span><span class="o">.</span><span class="n">explain</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">to_maximize</span><span class="o">=</span><span class="n">target</span><span class="p">,</span><span class="n">savefig</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="TSInterpret.InterpretabilityModels.counterfactual.Ates.AtesCF.plot">
<code class="highlight language-python"><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">org_label</span><span class="p">,</span> <span class="n">exp</span><span class="p">,</span> <span class="n">cf_label</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Basic Plot Function for visualizing Coutnerfactuals.
Parameters</p>
<hr />
<p>!!! instance "np.array"
    Not encoded and not normalised factual examples in two-dimensional shape (m, n).
Returns</p>
<hr />
<p>pd.DataFrame
    Encoded and normalised counterfactual examples.</p>

        <details class="quote">
          <summary>Source code in <code>counterfactual/Ates.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">item</span><span class="p">,</span><span class="n">org_label</span><span class="p">,</span><span class="n">exp</span><span class="p">,</span><span class="n">cf_label</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">15</span><span class="p">)):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">item</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">item</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> 

    <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;classic&quot;</span><span class="p">)</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;#08F7FE&#39;</span><span class="p">,</span>  <span class="c1"># teal/cyan</span>
        <span class="s1">&#39;#FE53BB&#39;</span><span class="p">,</span>  <span class="c1"># pink</span>
        <span class="s1">&#39;#F5D300&#39;</span><span class="p">,</span>  <span class="c1"># yellow</span>
        <span class="s1">&#39;#00ff41&#39;</span><span class="p">,</span>  <span class="c1"># matrix green</span>
    <span class="p">]</span>
    <span class="c1">#Figure out number changed channels</span>
    <span class="c1">#index= np.where(np.any(item))</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">item</span> <span class="o">!=</span> <span class="n">exp</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ind</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="c1">#Draw changed channels</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    <span class="c1">#print(ax)</span>
    <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="c1">#fig,ax=plt.subplot(len(ind[0]),1,i)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="sa">f</span><span class="s1">&#39;Predicted: </span><span class="si">{</span><span class="n">org_label</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">channel</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()),</span>
               <span class="sa">f</span><span class="s1">&#39;Counterfactual: </span><span class="si">{</span><span class="n">cf_label</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">exp</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">channel</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">())})</span>

        <span class="n">df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="c1"># Redraw the data with low alpha and slighty increased linewidth:</span>
        <span class="n">n_shades</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">diff_linewidth</span> <span class="o">=</span> <span class="mf">1.05</span>
        <span class="n">alpha_value</span> <span class="o">=</span> <span class="mf">0.3</span> <span class="o">/</span> <span class="n">n_shades</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_shades</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">diff_linewidth</span><span class="o">*</span><span class="n">n</span><span class="p">),</span>
            <span class="n">alpha</span><span class="o">=</span><span class="n">alpha_value</span><span class="p">,</span>
            <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">)</span>

        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;#2A3459&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time&#39;</span><span class="p">,</span> <span class="n">fontweight</span> <span class="o">=</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;large&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value&#39;</span><span class="p">,</span> <span class="n">fontweight</span> <span class="o">=</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;large&#39;</span><span class="p">)</span>
        <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span>
    <span class="c1">#plt.savefig(&#39;../Images/Initial_Example_Neon.pdf&#39;)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h2 class="doc doc-heading" id="TSInterpret.InterpretabilityModels.counterfactual.Ates.BaseExplanation">
        <code>
BaseExplanation        </code>



</h2>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>counterfactual/Ates.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">BaseExplanation</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clf</span><span class="p">,</span> <span class="n">timeseries</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">num_distractors</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dont_stop</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">threads</span><span class="o">=</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clf</span> <span class="o">=</span> <span class="n">clf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeseries</span> <span class="o">=</span> <span class="n">timeseries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">])</span>
        <span class="c1">#print(self.labels)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">silent</span> <span class="o">=</span> <span class="n">silent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_distractors</span> <span class="o">=</span> <span class="n">num_distractors</span>
        <span class="c1">#self.metrics = self.clf.steps[0][1].column_names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dont_stop</span> <span class="o">=</span> <span class="n">dont_stop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span> <span class="o">=</span><span class="n">timeseries</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1">#len(timeseries.loc[</span>
            <span class="c1">#timeseries.index.get_level_values(&#39;node_id&#39;)[0]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="o">=</span><span class="n">timeseries</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ts_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">timeseries</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ts_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">timeseries</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ts_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">timeseries</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tree</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">per_class_trees</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threads</span> <span class="o">=</span> <span class="n">threads</span>

    <span class="k">def</span> <span class="nf">explain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_test</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Please don&#39;t use the base class directly&quot;</span><span class="p">)</span>

    <span class="c1">#def _get_feature_names(self, clf, timeseries):</span>
    <span class="c1">#    if hasattr(self.clf.steps[1][1], &#39;transform&#39;):</span>
    <span class="c1">#        return self.clf.steps[2][1].column_names</span>
    <span class="c1">#    else:</span>
    <span class="c1">#        window_size = len(timeseries.loc[</span>
    <span class="c1">#            [timeseries.index.get_level_values(&#39;node_id&#39;)[0]], :, :])</span>
    <span class="c1">#        names = []</span>
    <span class="c1">#        for c in timeseries.columns:</span>
    <span class="c1">#            for i in range(window_size):</span>
    <span class="c1">#                names.append(c + &#39;_&#39; + str(i) + &#39;s&#39;)</span>
    <span class="c1">#       return names</span>

    <span class="c1">#def _transform_data(self, data, sample=None):</span>
    <span class="c1">#    if hasattr(self.clf.steps[1][1], &#39;transform&#39;):</span>
    <span class="c1">#        transformed = self.clf.steps[1][1].transform(data)</span>
    <span class="c1">#        if sample:</span>
    <span class="c1">#            transformed = transformed.sample(sample)</span>
    <span class="c1">#        return self.clf.steps[3][1].transform(transformed)</span>
    <span class="c1">#    else:</span>
            <span class="c1"># autoencoder</span>
    <span class="c1">#        train_set = []</span>
    <span class="c1">#        for node_id in data.index.get_level_values(&#39;node_id&#39;).unique():</span>
    <span class="c1">#            train_set.append(data.loc[[node_id], :, :].values.T.flatten())</span>
    <span class="c1">#        result = np.stack(train_set)</span>
    <span class="c1">#        if sample:</span>
    <span class="c1">#            idx = np.random.randint(len(result), size=sample)</span>
    <span class="c1">#            result = result[idx, :]</span>
    <span class="c1">#        return result</span>

    <span class="k">def</span> <span class="nf">_plot_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">original</span><span class="p">,</span> <span class="n">distractor</span><span class="p">,</span> <span class="n">savefig</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="c1">#print(distractor.shape)</span>
        <span class="c1">#print(original.shape)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">distractor</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
                 <span class="n">original</span><span class="p">[</span><span class="n">metric</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;x$_</span><span class="si">{test}</span><span class="s1">$&#39;</span><span class="p">,</span>
                 <span class="n">figure</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span>
                 <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">distractor</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
                 <span class="n">distractor</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">metric</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Distractor&#39;</span><span class="p">,</span>
                 <span class="n">figure</span><span class="o">=</span><span class="n">fig</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (s)&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">savefig</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.pdf&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Saved the figure to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">construct_per_class_trees</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Used to choose distractors&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">per_class_trees</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">per_class_trees</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">per_class_node_indices</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)}</span>
        <span class="c1">#todo predict</span>
        <span class="c1">#print(&#39;timeseries&#39;,self.timeseries.shape)</span>
        <span class="n">input_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeseries</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">window_size</span><span class="p">)</span>
        <span class="c1">#print(&#39;input&#39;,input_.shape)</span>
        <span class="n">preds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clf</span><span class="p">(</span><span class="n">input_</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1">#print(preds)</span>
        <span class="c1">#print(self.labels)</span>
        <span class="c1">#preds = self.clf.predict(self.timeseries)</span>
        <span class="n">true_positive_node_ids</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)}</span>
        <span class="c1">#print(type(true_positive_node_ids))</span>
        <span class="c1">#print(&#39;Index&#39;)</span>
        <span class="k">for</span> <span class="n">pred</span><span class="p">,</span> <span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()):</span>

            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pred</span><span class="p">:</span>
                <span class="c1">#print(idx)</span>
                <span class="n">true_positive_node_ids</span><span class="p">[</span><span class="n">pred</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="c1">#print(true_positive_node_ids)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span>  <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">):</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1">#print(&#39;c&#39;,c)</span>
            <span class="k">for</span> <span class="n">node_id</span> <span class="ow">in</span> <span class="n">true_positive_node_ids</span><span class="p">[</span><span class="n">c</span><span class="p">]:</span>
                <span class="c1">#print(&#39;NodeID&#39;,node_id)</span>
                <span class="n">dataset</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeseries</span><span class="p">[</span>
                    <span class="p">[</span><span class="n">node_id</span><span class="p">],</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
                <span class="c1">#print(&#39;timeseries&#39;,self.timeseries[node_id])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">per_class_node_indices</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node_id</span><span class="p">)</span>
            <span class="c1">#print(np.array(dataset).shape)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">per_class_trees</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">KDTree</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">dataset</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">per_class_trees</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Due to lack of true postitives for class </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s1"> no kd-tree could be build.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">silent</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Finished constructing per class kdtree&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">construct_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">train_set</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">node_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeseries</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span>
                <span class="s1">&#39;node_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
            <span class="n">train_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeseries</span><span class="p">[</span>
                <span class="p">[</span><span class="n">node_id</span><span class="p">],</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">node_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tree</span> <span class="o">=</span> <span class="n">KDTree</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">train_set</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">silent</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Finished constructing the kdtree&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_distractors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_test</span><span class="p">,</span> <span class="n">to_maximize</span><span class="p">,</span> <span class="n">n_distractors</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">construct_per_class_trees</span><span class="p">()</span>
        <span class="c1"># to_maximize can be int, string or np.int64</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">to_maximize</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Integral</span><span class="p">):</span>
            <span class="n">to_maximize</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)[</span><span class="n">to_maximize</span><span class="p">]</span>
        <span class="n">distractors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1">#print(&#39;to_maximize&#39;,to_maximize)</span>
        <span class="c1">#print(&#39;Class Tree&#39;,self.per_class_trees)</span>
        <span class="c1">#print(&#39;Class Tree with id&#39;,self.per_class_trees[to_maximize])</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">per_class_trees</span><span class="p">[</span><span class="n">to_maximize</span><span class="p">]</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                <span class="n">x_test</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                <span class="n">k</span><span class="o">=</span><span class="n">n_distractors</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">():</span>
            <span class="n">distractors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeseries</span><span class="p">[</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">per_class_node_indices</span><span class="p">[</span><span class="n">to_maximize</span><span class="p">][</span><span class="n">idx</span><span class="p">]],</span> <span class="p">:,</span> <span class="p">:])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">silent</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Returning distractors </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">[</span>
                <span class="n">x</span><span class="c1">#.index.get_level_values(&#39;node_id&#39;).unique().values[0]</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">distractors</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">distractors</span>

    <span class="k">def</span> <span class="nf">local_lipschitz_estimate</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">optim</span><span class="o">=</span><span class="s1">&#39;gp&#39;</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bound_type</span><span class="o">=</span><span class="s1">&#39;box&#39;</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">n_calls</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">njobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">exp_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">n_neighbors</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute one-sided lipschitz estimate for explainer.</span>
<span class="sd">        Adequate for local Lipschitz, for global must have</span>
<span class="sd">        the two sided version. This computes:</span>
<span class="sd">            max_z || f(x) - f(z)|| / || x - z||</span>
<span class="sd">        Instead of:</span>
<span class="sd">            max_z1,z2 || f(z1) - f(z2)|| / || z1 - z2||</span>
<span class="sd">        If n_neighbors is provided, does a local search on n closest neighbors</span>
<span class="sd">        If eps provided, does local lipzshitz in:</span>
<span class="sd">            - box of width 2*eps along each dimension if bound_type = &#39;box&#39;</span>
<span class="sd">            - box of width 2*eps*va, along each dimension if bound_type =</span>
<span class="sd">                &#39;box_norm&#39; (i.e. normalize so that deviation is</span>
<span class="sd">                eps % in each dim )</span>
<span class="sd">            - box of width 2*eps*std along each dimension if bound_type =</span>
<span class="sd">                &#39;box_std&#39;</span>
<span class="sd">        max_z || f(x) - f(z)|| / || x - z||   , with f = theta</span>
<span class="sd">        clip: clip bounds to within (min, max) of dataset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">np_x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">n_neighbors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">construct_tree</span><span class="p">()</span>

        <span class="c1"># Compute bounds for optimization</span>
        <span class="k">if</span> <span class="n">eps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># If want to find global lipzhitz ratio maximizer</span>
            <span class="c1"># search over &quot;all space&quot; - use max min bounds of dataset</span>
            <span class="c1"># fold of interest</span>
            <span class="n">lwr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts_min</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">upr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts_max</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">bound_type</span> <span class="o">==</span> <span class="s1">&#39;box&#39;</span><span class="p">:</span>
            <span class="n">lwr</span> <span class="o">=</span> <span class="p">(</span><span class="n">np_x</span> <span class="o">-</span> <span class="n">eps</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">upr</span> <span class="o">=</span> <span class="p">(</span><span class="n">np_x</span> <span class="o">+</span> <span class="n">eps</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">bound_type</span> <span class="o">==</span> <span class="s1">&#39;box_std&#39;</span><span class="p">:</span>
            <span class="n">lwr</span> <span class="o">=</span> <span class="p">(</span><span class="n">np_x</span> <span class="o">-</span> <span class="n">eps</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts_std</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">upr</span> <span class="o">=</span> <span class="p">(</span><span class="n">np_x</span> <span class="o">+</span> <span class="n">eps</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts_std</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">clip</span><span class="p">:</span>
            <span class="n">lwr</span> <span class="o">=</span> <span class="n">lwr</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ts_min</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
            <span class="n">upr</span> <span class="o">=</span> <span class="n">upr</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="nb">max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ts_max</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">exp_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">exp_kwargs</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">consts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">variable_indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">lwr</span><span class="p">,</span> <span class="n">upr</span><span class="p">])):</span>
            <span class="k">if</span> <span class="n">u</span> <span class="o">==</span> <span class="n">l</span><span class="p">:</span>
                <span class="n">consts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">consts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">bounds</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">l</span><span class="p">,</span> <span class="n">u</span><span class="p">))</span>
                <span class="n">variable_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="n">consts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">consts</span><span class="p">)</span>
        <span class="n">variable_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">variable_indices</span><span class="p">)</span>

        <span class="n">orig_explanation</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">explain</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">**</span><span class="n">exp_kwargs</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Original explanation: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">orig_explanation</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">lipschitz_ratio</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
            <span class="k">nonlocal</span> <span class="bp">self</span>
            <span class="k">nonlocal</span> <span class="n">consts</span>
            <span class="k">nonlocal</span> <span class="n">variable_indices</span>
            <span class="k">nonlocal</span> <span class="n">orig_explanation</span>
            <span class="k">nonlocal</span> <span class="n">np_x</span>
            <span class="k">nonlocal</span> <span class="n">exp_kwargs</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">consts</span><span class="p">):</span>
                <span class="c1"># For random search</span>
                <span class="n">consts</span> <span class="o">=</span> <span class="n">y</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Only search in variables that vary</span>
                <span class="n">np</span><span class="o">.</span><span class="n">put_along_axis</span><span class="p">(</span><span class="n">consts</span><span class="p">,</span> <span class="n">variable_indices</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">df_y</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">consts</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">),</span>
                                                          <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                                <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">)</span>
            <span class="n">df_y</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_y</span><span class="p">],</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;node_id&#39;</span><span class="p">])</span>
            <span class="n">new_explanation</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">explain</span><span class="p">(</span><span class="n">df_y</span><span class="p">,</span> <span class="o">**</span><span class="n">exp_kwargs</span><span class="p">))</span>
            <span class="c1"># Hamming distance</span>
            <span class="n">exp_distance</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">orig_explanation</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">new_explanation</span><span class="p">))</span> \
                <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_explanation</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">orig_explanation</span><span class="p">))</span>
            <span class="c1"># Multiply by 1B to get a sensible number</span>
            <span class="n">ratio</span> <span class="o">=</span> <span class="n">exp_distance</span> <span class="o">*</span> <span class="o">-</span><span class="mf">1e9</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np_x</span> <span class="o">-</span> <span class="n">consts</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Ratio: </span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ratio</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ratio</span>

        <span class="c1"># Run optimization</span>
        <span class="n">min_ratio</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">worst_case</span> <span class="o">=</span> <span class="n">np_x</span>
        <span class="k">if</span> <span class="n">n_neighbors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">np_x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                                       <span class="n">k</span><span class="o">=</span><span class="n">n_neighbors</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">():</span>
                <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeseries</span><span class="p">[</span>
                    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">node_indices</span><span class="p">[</span><span class="n">idx</span><span class="p">]],</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="n">ratio</span> <span class="o">=</span> <span class="n">lipschitz_ratio</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ratio</span> <span class="o">&lt;</span> <span class="n">min_ratio</span><span class="p">:</span>
                    <span class="n">min_ratio</span> <span class="o">=</span> <span class="n">ratio</span>
                    <span class="n">worst_case</span> <span class="o">=</span> <span class="n">y</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;The worst case explanation was for </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">optim</span> <span class="o">==</span> <span class="s1">&#39;gp&#39;</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Running BlackBox Minimization with Bayesian Opt&#39;</span><span class="p">)</span>
            <span class="c1"># Need minus because gp only has minimize method</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">gp_minimize</span><span class="p">(</span><span class="n">lipschitz_ratio</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">n_calls</span><span class="o">=</span><span class="n">n_calls</span><span class="p">,</span>
                              <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="n">njobs</span><span class="p">)</span>
            <span class="n">min_ratio</span><span class="p">,</span> <span class="n">worst_case</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;fun&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">optim</span> <span class="o">==</span> <span class="s1">&#39;gbrt&#39;</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Running BlackBox Minimization with GBT&#39;</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">gbrt_minimize</span><span class="p">(</span><span class="n">lipschitz_ratio</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">n_calls</span><span class="o">=</span><span class="n">n_calls</span><span class="p">,</span>
                                <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="n">njobs</span><span class="p">)</span>
            <span class="n">min_ratio</span><span class="p">,</span> <span class="n">worst_case</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;fun&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">optim</span> <span class="o">==</span> <span class="s1">&#39;random&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_calls</span><span class="p">):</span>
                <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">upr</span> <span class="o">-</span> <span class="n">lwr</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">np_x</span><span class="p">))</span> <span class="o">+</span> <span class="n">lwr</span>
                <span class="n">ratio</span> <span class="o">=</span> <span class="n">lipschitz_ratio</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ratio</span> <span class="o">&lt;</span> <span class="n">min_ratio</span><span class="p">:</span>
                    <span class="n">min_ratio</span> <span class="o">=</span> <span class="n">ratio</span>
                    <span class="n">worst_case</span> <span class="o">=</span> <span class="n">y</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">worst_case</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">consts</span><span class="p">):</span>
            <span class="n">np</span><span class="o">.</span><span class="n">put_along_axis</span><span class="p">(</span><span class="n">consts</span><span class="p">,</span> <span class="n">variable_indices</span><span class="p">,</span> <span class="n">worst_case</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Best ratio: </span><span class="si">%f</span><span class="s2">, norm: </span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">min_ratio</span><span class="p">,</span>
                         <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np_x</span> <span class="o">-</span> <span class="n">consts</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">min_ratio</span><span class="p">,</span> <span class="n">consts</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">










  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="TSInterpret.InterpretabilityModels.counterfactual.Ates.BaseExplanation.construct_per_class_trees">
<code class="highlight language-python"><span class="n">construct_per_class_trees</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Used to choose distractors</p>

        <details class="quote">
          <summary>Source code in <code>counterfactual/Ates.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">construct_per_class_trees</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Used to choose distractors&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">per_class_trees</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">per_class_trees</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">per_class_node_indices</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)}</span>
    <span class="c1">#todo predict</span>
    <span class="c1">#print(&#39;timeseries&#39;,self.timeseries.shape)</span>
    <span class="n">input_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeseries</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">window_size</span><span class="p">)</span>
    <span class="c1">#print(&#39;input&#39;,input_.shape)</span>
    <span class="n">preds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clf</span><span class="p">(</span><span class="n">input_</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1">#print(preds)</span>
    <span class="c1">#print(self.labels)</span>
    <span class="c1">#preds = self.clf.predict(self.timeseries)</span>
    <span class="n">true_positive_node_ids</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)}</span>
    <span class="c1">#print(type(true_positive_node_ids))</span>
    <span class="c1">#print(&#39;Index&#39;)</span>
    <span class="k">for</span> <span class="n">pred</span><span class="p">,</span> <span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()):</span>

        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pred</span><span class="p">:</span>
            <span class="c1">#print(idx)</span>
            <span class="n">true_positive_node_ids</span><span class="p">[</span><span class="n">pred</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
    <span class="c1">#print(true_positive_node_ids)</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span>  <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">):</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1">#print(&#39;c&#39;,c)</span>
        <span class="k">for</span> <span class="n">node_id</span> <span class="ow">in</span> <span class="n">true_positive_node_ids</span><span class="p">[</span><span class="n">c</span><span class="p">]:</span>
            <span class="c1">#print(&#39;NodeID&#39;,node_id)</span>
            <span class="n">dataset</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeseries</span><span class="p">[</span>
                <span class="p">[</span><span class="n">node_id</span><span class="p">],</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
            <span class="c1">#print(&#39;timeseries&#39;,self.timeseries[node_id])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">per_class_node_indices</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node_id</span><span class="p">)</span>
        <span class="c1">#print(np.array(dataset).shape)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">per_class_trees</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">KDTree</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">dataset</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">per_class_trees</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Due to lack of true postitives for class </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s1"> no kd-tree could be build.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">silent</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Finished constructing per class kdtree&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="TSInterpret.InterpretabilityModels.counterfactual.Ates.BaseExplanation.local_lipschitz_estimate">
<code class="highlight language-python"><span class="n">local_lipschitz_estimate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">optim</span><span class="o">=</span><span class="s1">&#39;gp&#39;</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bound_type</span><span class="o">=</span><span class="s1">&#39;box&#39;</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">n_calls</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">njobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">exp_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_neighbors</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Compute one-sided lipschitz estimate for explainer.
Adequate for local Lipschitz, for global must have
the two sided version. This computes:
    max_z || f(x) - f(z)|| / || x - z||
Instead of:
    max_z1,z2 || f(z1) - f(z2)|| / || z1 - z2||
If n_neighbors is provided, does a local search on n closest neighbors
If eps provided, does local lipzshitz in:
    - box of width 2<em>eps along each dimension if bound_type = 'box'
    - box of width 2</em>eps<em>va, along each dimension if bound_type =
        'box_norm' (i.e. normalize so that deviation is
        eps % in each dim )
    - box of width 2</em>eps*std along each dimension if bound_type =
        'box_std'
max_z || f(x) - f(z)|| / || x - z||   , with f = theta
clip: clip bounds to within (min, max) of dataset</p>

        <details class="quote">
          <summary>Source code in <code>counterfactual/Ates.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">local_lipschitz_estimate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">optim</span><span class="o">=</span><span class="s1">&#39;gp&#39;</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bound_type</span><span class="o">=</span><span class="s1">&#39;box&#39;</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">n_calls</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">njobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">exp_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">n_neighbors</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute one-sided lipschitz estimate for explainer.</span>
<span class="sd">    Adequate for local Lipschitz, for global must have</span>
<span class="sd">    the two sided version. This computes:</span>
<span class="sd">        max_z || f(x) - f(z)|| / || x - z||</span>
<span class="sd">    Instead of:</span>
<span class="sd">        max_z1,z2 || f(z1) - f(z2)|| / || z1 - z2||</span>
<span class="sd">    If n_neighbors is provided, does a local search on n closest neighbors</span>
<span class="sd">    If eps provided, does local lipzshitz in:</span>
<span class="sd">        - box of width 2*eps along each dimension if bound_type = &#39;box&#39;</span>
<span class="sd">        - box of width 2*eps*va, along each dimension if bound_type =</span>
<span class="sd">            &#39;box_norm&#39; (i.e. normalize so that deviation is</span>
<span class="sd">            eps % in each dim )</span>
<span class="sd">        - box of width 2*eps*std along each dimension if bound_type =</span>
<span class="sd">            &#39;box_std&#39;</span>
<span class="sd">    max_z || f(x) - f(z)|| / || x - z||   , with f = theta</span>
<span class="sd">    clip: clip bounds to within (min, max) of dataset</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">np_x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">n_neighbors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">construct_tree</span><span class="p">()</span>

    <span class="c1"># Compute bounds for optimization</span>
    <span class="k">if</span> <span class="n">eps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># If want to find global lipzhitz ratio maximizer</span>
        <span class="c1"># search over &quot;all space&quot; - use max min bounds of dataset</span>
        <span class="c1"># fold of interest</span>
        <span class="n">lwr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts_min</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">upr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts_max</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">bound_type</span> <span class="o">==</span> <span class="s1">&#39;box&#39;</span><span class="p">:</span>
        <span class="n">lwr</span> <span class="o">=</span> <span class="p">(</span><span class="n">np_x</span> <span class="o">-</span> <span class="n">eps</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">upr</span> <span class="o">=</span> <span class="p">(</span><span class="n">np_x</span> <span class="o">+</span> <span class="n">eps</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">bound_type</span> <span class="o">==</span> <span class="s1">&#39;box_std&#39;</span><span class="p">:</span>
        <span class="n">lwr</span> <span class="o">=</span> <span class="p">(</span><span class="n">np_x</span> <span class="o">-</span> <span class="n">eps</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts_std</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">upr</span> <span class="o">=</span> <span class="p">(</span><span class="n">np_x</span> <span class="o">+</span> <span class="n">eps</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts_std</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">clip</span><span class="p">:</span>
        <span class="n">lwr</span> <span class="o">=</span> <span class="n">lwr</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ts_min</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
        <span class="n">upr</span> <span class="o">=</span> <span class="n">upr</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="nb">max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ts_max</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">exp_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">exp_kwargs</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">consts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">bounds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">variable_indices</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">lwr</span><span class="p">,</span> <span class="n">upr</span><span class="p">])):</span>
        <span class="k">if</span> <span class="n">u</span> <span class="o">==</span> <span class="n">l</span><span class="p">:</span>
            <span class="n">consts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">consts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">bounds</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">l</span><span class="p">,</span> <span class="n">u</span><span class="p">))</span>
            <span class="n">variable_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
    <span class="n">consts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">consts</span><span class="p">)</span>
    <span class="n">variable_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">variable_indices</span><span class="p">)</span>

    <span class="n">orig_explanation</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">explain</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">**</span><span class="n">exp_kwargs</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Original explanation: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">orig_explanation</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">lipschitz_ratio</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
        <span class="k">nonlocal</span> <span class="bp">self</span>
        <span class="k">nonlocal</span> <span class="n">consts</span>
        <span class="k">nonlocal</span> <span class="n">variable_indices</span>
        <span class="k">nonlocal</span> <span class="n">orig_explanation</span>
        <span class="k">nonlocal</span> <span class="n">np_x</span>
        <span class="k">nonlocal</span> <span class="n">exp_kwargs</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">consts</span><span class="p">):</span>
            <span class="c1"># For random search</span>
            <span class="n">consts</span> <span class="o">=</span> <span class="n">y</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Only search in variables that vary</span>
            <span class="n">np</span><span class="o">.</span><span class="n">put_along_axis</span><span class="p">(</span><span class="n">consts</span><span class="p">,</span> <span class="n">variable_indices</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">df_y</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">consts</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">),</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                            <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">)</span>
        <span class="n">df_y</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_y</span><span class="p">],</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;node_id&#39;</span><span class="p">])</span>
        <span class="n">new_explanation</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">explain</span><span class="p">(</span><span class="n">df_y</span><span class="p">,</span> <span class="o">**</span><span class="n">exp_kwargs</span><span class="p">))</span>
        <span class="c1"># Hamming distance</span>
        <span class="n">exp_distance</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">orig_explanation</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">new_explanation</span><span class="p">))</span> \
            <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_explanation</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">orig_explanation</span><span class="p">))</span>
        <span class="c1"># Multiply by 1B to get a sensible number</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="n">exp_distance</span> <span class="o">*</span> <span class="o">-</span><span class="mf">1e9</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np_x</span> <span class="o">-</span> <span class="n">consts</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Ratio: </span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ratio</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ratio</span>

    <span class="c1"># Run optimization</span>
    <span class="n">min_ratio</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">worst_case</span> <span class="o">=</span> <span class="n">np_x</span>
    <span class="k">if</span> <span class="n">n_neighbors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">np_x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                                   <span class="n">k</span><span class="o">=</span><span class="n">n_neighbors</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">():</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeseries</span><span class="p">[</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">node_indices</span><span class="p">[</span><span class="n">idx</span><span class="p">]],</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">ratio</span> <span class="o">=</span> <span class="n">lipschitz_ratio</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ratio</span> <span class="o">&lt;</span> <span class="n">min_ratio</span><span class="p">:</span>
                <span class="n">min_ratio</span> <span class="o">=</span> <span class="n">ratio</span>
                <span class="n">worst_case</span> <span class="o">=</span> <span class="n">y</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;The worst case explanation was for </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">optim</span> <span class="o">==</span> <span class="s1">&#39;gp&#39;</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Running BlackBox Minimization with Bayesian Opt&#39;</span><span class="p">)</span>
        <span class="c1"># Need minus because gp only has minimize method</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">gp_minimize</span><span class="p">(</span><span class="n">lipschitz_ratio</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">n_calls</span><span class="o">=</span><span class="n">n_calls</span><span class="p">,</span>
                          <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="n">njobs</span><span class="p">)</span>
        <span class="n">min_ratio</span><span class="p">,</span> <span class="n">worst_case</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;fun&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">optim</span> <span class="o">==</span> <span class="s1">&#39;gbrt&#39;</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Running BlackBox Minimization with GBT&#39;</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">gbrt_minimize</span><span class="p">(</span><span class="n">lipschitz_ratio</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">n_calls</span><span class="o">=</span><span class="n">n_calls</span><span class="p">,</span>
                            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="n">njobs</span><span class="p">)</span>
        <span class="n">min_ratio</span><span class="p">,</span> <span class="n">worst_case</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;fun&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">optim</span> <span class="o">==</span> <span class="s1">&#39;random&#39;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_calls</span><span class="p">):</span>
            <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">upr</span> <span class="o">-</span> <span class="n">lwr</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">np_x</span><span class="p">))</span> <span class="o">+</span> <span class="n">lwr</span>
            <span class="n">ratio</span> <span class="o">=</span> <span class="n">lipschitz_ratio</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ratio</span> <span class="o">&lt;</span> <span class="n">min_ratio</span><span class="p">:</span>
                <span class="n">min_ratio</span> <span class="o">=</span> <span class="n">ratio</span>
                <span class="n">worst_case</span> <span class="o">=</span> <span class="n">y</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">worst_case</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">consts</span><span class="p">):</span>
        <span class="n">np</span><span class="o">.</span><span class="n">put_along_axis</span><span class="p">(</span><span class="n">consts</span><span class="p">,</span> <span class="n">variable_indices</span><span class="p">,</span> <span class="n">worst_case</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Best ratio: </span><span class="si">%f</span><span class="s2">, norm: </span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">min_ratio</span><span class="p">,</span>
                     <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np_x</span> <span class="o">-</span> <span class="n">consts</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">min_ratio</span><span class="p">,</span> <span class="n">consts</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>




  <div class="doc doc-object doc-class">



<h2 class="doc doc-heading" id="TSInterpret.InterpretabilityModels.counterfactual.Ates.LossDiscreteState">
        <code>
LossDiscreteState        </code>



</h2>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>counterfactual/Ates.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">LossDiscreteState</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label_idx</span><span class="p">,</span> <span class="n">clf</span><span class="p">,</span> <span class="n">x_test</span><span class="p">,</span> <span class="n">distractor</span><span class="p">,</span> <span class="n">cols_swap</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span>
                 <span class="n">max_features</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">maximize</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">label_idx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clf</span> <span class="o">=</span> <span class="n">clf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">reg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distractor</span> <span class="o">=</span> <span class="n">distractor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cols_swap</span> <span class="o">=</span> <span class="n">cols_swap</span>  <span class="c1"># Column names that we can swap</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prob_type</span> <span class="o">=</span> <span class="s1">&#39;discrete&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_features</span> <span class="o">=</span> <span class="mi">3</span> <span class="k">if</span> <span class="n">max_features</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">max_features</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maximize</span> <span class="o">=</span> <span class="n">maximize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span><span class="o">=</span> <span class="n">x_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="o">=</span> <span class="n">x_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature_matrix</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">feature_matrix</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature_matrix</span><span class="p">):</span>

        <span class="n">new_case</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_test</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cols_swap</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">feature_matrix</span><span class="p">)</span>

        <span class="c1"># If the value is one, replace from distractor</span>
        <span class="k">for</span> <span class="n">col_replace</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cols_swap</span><span class="p">,</span> <span class="n">feature_matrix</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1">#print(new_case.shape)</span>
                <span class="c1">#print(self.distractor.shape)</span>
                <span class="n">new_case</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">col_replace</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">distractor</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">col_replace</span><span class="p">]</span>

        <span class="n">replaced_feature_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">feature_matrix</span><span class="p">)</span>

        <span class="c1"># if replaced_feature_count &gt; self.max_features:</span>
        <span class="c1">#     feature_loss = 1</span>
        <span class="c1">#     loss_pred = 1</span>
        <span class="c1"># else:</span>
        <span class="c1"># Will return the prob of the other class</span>
        <span class="n">input_</span> <span class="o">=</span> <span class="n">new_case</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">window_size</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clf</span><span class="p">(</span><span class="n">input_</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">]</span>
        <span class="c1">#result = self.clf.predict_proba(new_case)[0][self.target]</span>
        <span class="n">feature_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">replaced_feature_count</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_features</span><span class="p">)</span>
        <span class="n">loss_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.95</span> <span class="o">-</span> <span class="n">result</span><span class="p">))</span>

        <span class="n">loss_pred</span> <span class="o">=</span> <span class="n">loss_pred</span> <span class="o">+</span> <span class="n">feature_loss</span>
        <span class="c1">#print(loss_pred)</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">loss_pred</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">maximize</span> <span class="k">else</span> <span class="n">loss_pred</span>

    <span class="k">def</span> <span class="nf">get_prob_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the problem type.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">prob_type</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">












  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="TSInterpret.InterpretabilityModels.counterfactual.Ates.LossDiscreteState.get_prob_type">
<code class="highlight language-python"><span class="n">get_prob_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Return the problem type.</p>

        <details class="quote">
          <summary>Source code in <code>counterfactual/Ates.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_prob_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Return the problem type.&quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">prob_type</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>








  </div>

    </div>

  </div>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/vendor.92ffa368.min.js"></script>
      <script src="../../assets/javascripts/bundle.5123e3d4.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "../..",
          features: [],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.a68abb33.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>